# AUTOGENERATED! DO NOT EDIT! File to edit: nbdev_nbs/speclib/predict_lib.ipynb (unless otherwise specified).

__all__ = ['PredictLib']

# Cell
from alphabase.speclib.library_base import SpecLibBase
from alphadeep.model.msms import pDeepModel
from alphadeep.model.RT import AlphaRTModel
from alphadeep.model.CCS import AlphaCCSModel

class PredictLib(SpecLibBase):
    def __init__(self,
        charged_ion_types, #['b_1+','b_2+','y_1+','y_2+', ...]
        msms_model: pDeepModel,
        rt_model: AlphaRTModel,
        ccs_model: AlphaCCSModel,
        min_frag_mz = 200, max_frag_mz = 2000,
        min_precursor_mz = 500, max_precursor_mz = 2000,
    ):
        super().__init__(
            charged_ion_types,
            min_frag_mz=min_frag_mz,
            max_frag_mz=max_frag_mz,
            min_precursor_mz=min_precursor_mz,
            max_precursor_mz=max_precursor_mz
        )
        self.msms_model = msms_model
        self.rt_model = rt_model
        self.ccs_model = ccs_model

        self.inten_factor = 10000

    @property
    def precursor_df(self):
        return self._precursor_df

    @precursor_df.setter
    def precursor_df(self, df):
        super().precursor_df(df)
        # add 'predict_RT' into columns
        self._precursor_df = self.rt_model.predict(self._precursor_df)
        # add 'predict_CCS' into columns
        self._precursor_df = self.ccs_model.predict(self._precursor_df)

    def load_fragment_inten_df(self, **kwargs):
        if self._fragment_mass_df is None:
            self.load_fragment_mass_df()

        frag_inten_df = self.msms_model.predict(
            self._precursor_df,
            self._fragment_mass_df,
        )

        # it does not make sense to
        charged_frag_list = []
        for frag_type in self._fragment_mass_df.columns.values:
            if frag_type in frag_inten_df:
                charged_frag_list.append(frag_type)
        self._fragment_mass_df = self._fragment_mass_df[charged_frag_list]
        self._fragment_inten_df = frag_inten_df[charged_frag_list]*self.inten_factor


