---

title: Functionalities to extract features from peptdeep prediction


keywords: fastai
sidebar: home_sidebar



nb_path: "nbdev_nbs/rescore/feature_extractor.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbdev_nbs/rescore/feature_extractor.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="match_one_raw" class="doc_header"><code>match_one_raw</code><a href="https://github.com/MannLabs/peptdeep/tree/main/peptdeep/rescore/feature_extractor.py#L30" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>match_one_raw</code>(<strong><code>psm_df_one_raw</code></strong>, <strong><code>ms2_file</code></strong>, <strong><code>ms2_file_type</code></strong>, <strong><code>frag_types_to_match</code></strong>, <strong><code>ms2_ppm</code></strong>, <strong><code>ms2_tol</code></strong>, <strong><code>calibrate_frag_mass_error</code></strong>)</p>
</blockquote>
<p>Internal function</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_psm_scores" class="doc_header"><code>get_psm_scores</code><a href="https://github.com/MannLabs/peptdeep/tree/main/peptdeep/rescore/feature_extractor.py#L70" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_psm_scores</code>(<strong><code>psm_df</code></strong>:<code>DataFrame</code>, <strong><code>predict_intensity_df</code></strong>:<code>DataFrame</code>, <strong><code>matched_intensity_df</code></strong>:<code>DataFrame</code>, <strong><code>matched_mass_err_df</code></strong>:<code>DataFrame</code>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_ms2_features" class="doc_header"><code>get_ms2_features</code><a href="https://github.com/MannLabs/peptdeep/tree/main/peptdeep/rescore/feature_extractor.py#L112" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_ms2_features</code>(<strong><code>psm_df</code></strong>, <strong><code>frag_types</code></strong>, <strong><code>predict_intensity_df</code></strong>, <strong><code>matched_intensity_df</code></strong>, <strong><code>matched_mass_err_df</code></strong>)</p>
</blockquote>
<p>Extract ms2 features from the given
predict_intensity_df and matched_intensity_df. It will add columns into psm_df:
  cos: cosine similarity between predicted and matched fragments
  pcc: pearson correlation between predicted and matched fragments
  sa: spectral angle between predicted and matched fragments
  spc: Spearman's rank correlation between predicted and matched fragments.
  cos_bion: ...
  cos_yion: ...
  pcc_bion: ...
  pcc_yion: ...
  sa_bion: ...
  sa_yion: ...
  spc_bion: ...
  spc_yion: ...
  matched_frag_ratio: # matched fragments / # total b+y fragments
  matched_bion_ratio: # matched b fragments / # total b fragments
  matched_yion_ratio: # matched y fragments / # total y fragments
  and more ...</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="match_one_raw_mp" class="doc_header"><code>match_one_raw_mp</code><a href="https://github.com/MannLabs/peptdeep/tree/main/peptdeep/rescore/feature_extractor.py#L459" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>match_one_raw_mp</code>(<strong><code>args</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_ms2_features_mp" class="doc_header"><code>get_ms2_features_mp</code><a href="https://github.com/MannLabs/peptdeep/tree/main/peptdeep/rescore/feature_extractor.py#L463" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_ms2_features_mp</code>(<strong><code>args</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ScoreFeatureExtractor">ScoreFeatureExtractor<a class="anchor-link" href="#ScoreFeatureExtractor"> </a></h3><p><a href="/alphapeptdeep/feature_extractor.html#ScoreFeatureExtractor"><code>ScoreFeatureExtractor</code></a> and its sub-classes are the most important functionalities for rescoring.</p>
<p>They define the fine-tuning parameters to tune RT/CCS/MS2 models. They also define the feature list to feed to Percolator.</p>
<p>We recommend to use <a href="/alphapeptdeep/feature_extractor.html#ScoreFeatureExtractorMP"><code>ScoreFeatureExtractorMP</code></a> as it is faster by using multiprocessing while remain the prediction performance.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ScoreFeatureExtractor" class="doc_header"><code>class</code> <code>ScoreFeatureExtractor</code><a href="https://github.com/MannLabs/peptdeep/tree/main/peptdeep/rescore/feature_extractor.py#L469" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ScoreFeatureExtractor</code>(<strong><code>model_mgr</code></strong>:<a href="/alphapeptdeep/pretrained_models.html#ModelManager"><code>ModelManager</code></a>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="ScoreFeatureExtractorMP">ScoreFeatureExtractorMP<a class="anchor-link" href="#ScoreFeatureExtractorMP"> </a></h3><p><a href="/alphapeptdeep/feature_extractor.html#ScoreFeatureExtractorMP"><code>ScoreFeatureExtractorMP</code></a> uses multiprocessing to accelerate the feature extraction procedure. The pipeline is:</p>
<ol>
<li>Randomly select some raw files to fine-tuning the model. This step also includes two steps: a. ms2 matching with multiprocessing; b. model tuning with a single thread (or GPU). </li>
<li>Match PSM results of each raw file in the psm_df against the corresponding ms2 file in ms2_file_dict ({<code>raw_name</code>: <code>ms2_file_path</code>}) to get matched fragment intensity with multiprocessing.</li>
<li>Predict fragment intensity as well as RT and mobility with a single thread (or GPU). We use a single thread here becauase GPU memory is the main limitation, and we also enable raw-specific fine-tuning for different raw files.</li>
<li>Calculate the feature values with multiprocessing.</li>
</ol>
<p>The key in <a href="/alphapeptdeep/feature_extractor.html#ScoreFeatureExtractorMP"><code>ScoreFeatureExtractorMP</code></a> is to access the GPU section without multiprocessing to avoid GPU memory conflicts.</p>
<p>The processing speed is very fast with a normal GPU (GTX1080). In our testing, peptdeep can rescore 371 HLA raw files within 1 hour.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="ScoreFeatureExtractorMP" class="doc_header"><code>class</code> <code>ScoreFeatureExtractorMP</code><a href="https://github.com/MannLabs/peptdeep/tree/main/peptdeep/rescore/feature_extractor.py#L838" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>ScoreFeatureExtractorMP</code>(<strong><code>model_mgr</code></strong>:<a href="/alphapeptdeep/pretrained_models.html#ModelManager"><code>ModelManager</code></a>) :: <a href="/alphapeptdeep/feature_extractor.html#ScoreFeatureExtractor"><code>ScoreFeatureExtractor</code></a></p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

</div>
 

